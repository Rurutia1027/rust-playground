name: Rust Playground CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test All Tutorials
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          sudo -u postgres psql -c "CREATE USER admin WITH PASSWORD 'admin';"
          sudo -u postgres psql -c "CREATE DATABASE defaultdb;"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE defaultdb TO admin;"

      - name: Run Database Setup Script # run script to prepare table in the defaultdb 
        run: |    
          echo $(pwd)
          chmod 755 ./tutorial-5/bin/setup-db.sh 
          sh tutorial-5/bin/setup-db.sh

      - name: Preapre the Database (Run sqlx prepare)
        run: |
          cd tutorial-5 && cargo sqlx prepare --database-url postgres://admin:admin@localhost:5432/defaultdb

      - name: Build and Test tutorial-1
        working-directory: ./tutorial-1
        env: 
          RUSTFLAGS: "-Awarnings"       # Suppress warnings
        run: |
          cargo build --verbose
          cargo test --verbose -- --nocapture

      - name: Build and Test tutorial-2
        working-directory: ./tutorial-2
        env:
          RUSTFLAGS: "-Awarnings"       # Suppress warnings
        run: |
          cargo build --verbose
          cargo test --verbose -- --nocapture

      - name: Build and Test tutorial-3
        working-directory: ./tutorial-3
        env:
          RUSTFLAGS: "-Awarnings"       # Suppress warnings
        run: |
          cargo build --verbose
          cargo test --verbose -- --nocapture

      - name: Build and Test tutorial-5
        working-directory: ./tutorial-5
        env:
          RUSTFLAGS: "-Awarnings"       # Suppress warnings
          DATABASE_URL: "postgresql://admin:admin@localhost:5432/defaultdb"  # Set database URL for tests
        run: |
          cargo build --verbose
          cargo test --verbose -- --nocapture